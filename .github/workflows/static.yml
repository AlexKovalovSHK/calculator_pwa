name: PWA Docker Deploy

on:
  push:
    branches: [ "main" ]

env:
  DOCKER_IMAGE_NAME: "pwa-rechner-prod"
  HOST_PORT: "8086"                  # Внешний порт, который выставляем на сервере
  CONTAINER_PORT: "80"               # Внутренний порт Nginx в контейнере
  DEPLOY_DIR: "/root/pwa_rechner/"   # Директория для размещения tar-файла на сервере

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # Шаг 1: Получение кода
      - uses: actions/checkout@v4

      # -----------------------------------------------
      # Сборка образа (CI)
      # -----------------------------------------------

      # Шаг 2: Создание папки dist и копирование PWA-файлов
      - name: Create dist directory and copy PWA files
        run: |
          mkdir -p dist
          # Копируем все необходимые файлы в dist/
          cp index.html sw.js manifest.json nginx.conf Dockerfile README.md dist/ 
          cp -r icons dist/ || true
          # Если у вас есть отдельный script.js, добавьте его здесь:
          # cp script.js dist/ || true 
          ls -R dist/ 

      # Шаг 3: Настройка Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Шаг 4: Сборка Docker-образа (используя ваш локально протестированный Dockerfile)
      - name: Build Docker image
        run: |
          docker build -t $DOCKER_IMAGE_NAME .

      # Шаг 5: Сохранение Docker-образа в tar-файл (для передачи)
      - name: Save Docker image
        run: |
          docker save $DOCKER_IMAGE_NAME -o $DOCKER_IMAGE_NAME.tar

      # -----------------------------------------------
      # Развертывание (CD)
      # -----------------------------------------------

      # Шаг 6: Установка sshpass
      - name: Install sshpass
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass

      # Шаг 7: Копирование на удаленный сервер
      - name: Copy and Prepare Remote Directory
        run: |
          # 1. Создаем директорию на сервере
          sshpass -p "${{ secrets.SUDO_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            mkdir -p $DEPLOY_DIR && chmod 777 $DEPLOY_DIR
          "
          # 2. Копируем tar-файл образа
          sshpass -p "${{ secrets.SUDO_PASSWORD }}" scp -o StrictHostKeyChecking=no $DOCKER_IMAGE_NAME.tar ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:$DEPLOY_DIR

      # Шаг 8: Развертывание (Загрузка образа и перезапуск контейнера)
      - name: Deploy Docker image on remote server
        run: |
          # ВНИМАНИЕ: Если вы используете НЕ пароль, а SSH-ключи, 
          # замените sshpass на стандартный ssh-agent, который более безопасен.
          sshpass -p "${{ secrets.SUDO_PASSWORD }}" ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
            cd $DEPLOY_DIR
            
            # Загружаем образ из tar-файла
            docker load -i $DOCKER_IMAGE_NAME.tar
            
            # 1. Останавливаем и удаляем старый контейнер
            docker stop $DOCKER_IMAGE_NAME || true 
            docker rm $DOCKER_IMAGE_NAME || true
            
            # 2. Запускаем новый контейнер
            docker run -d \
              --name $DOCKER_IMAGE_NAME \
              -p $HOST_PORT:$CONTAINER_PORT \
              $DOCKER_IMAGE_NAME
          "